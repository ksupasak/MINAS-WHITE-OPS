version: "3.9"

services:
  web:
    build: .
    command: bash -c "bundle install && bin/rails s -b 'ssl://0.0.0.0:3000?key=config/ssl/server.key&cert=config/ssl/server.crt'"
    volumes:
     - .:/rails
     - ./config/ssl:/rails/config/ssl
    env_file:
      - .env
    environment:
      MONGODB_URI: ${MONGODB_URI:-mongodb://mongo:27017/new_soup_development}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      NEO4J_URI: ${NEO4J_URI:-bolt://neo4j:7687}
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-devpassword}
      SECRET_KEY_BASE: cb8bad48c7938b18e443ca8914357870a576cb4f7515c491b653d643fb23e554eaa8ac4576d8b6f3411393ddd4cfb981639f27a67a0b9280d2db0b32f6ebef49
    depends_on:
      - mongo
      - redis
      - neo4j
    ports:
      - "3000:3000"

  sidekiq:
    build: .
    command: bash -c "bundle install && bundle exec sidekiq -C config/sidekiq.yml"
    volumes:
      - .:/rails
    env_file:
      - .env
    environment:
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      MONGODB_URI: ${MONGODB_URI:-mongodb://mongo:27017/new_soup_development}
      NEO4J_URI: ${NEO4J_URI:-bolt://neo4j:7687}
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-devpassword}
    depends_on:
      - redis
      - mongo
      - neo4j

  mongo:
    image: mongo:7
    restart: unless-stopped
    volumes:
      - mongo-data:/data/db
    ports:
      - "27017:27017"

  redis:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"

  neo4j:
    image: neo4j:5
    environment:
      - NEO4J_AUTH=neo4j/devpassword
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
    ports:
      - "7474:7474"
      - "7687:7687"

  tigergraph:
    image: tigergraph/tigergraph:3.9.3
    container_name: tigergraph
    environment:
      - LICENSE=true
    volumes:
      - tigergraph-data:/home/tigergraph/data
    ports:
      - "14240:14240" # GSQL/UI
      - "9000:9000"   # REST++
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -s http://localhost:9000/version || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    environment:
      - OLLAMA_HOST=0.0.0.0
    volumes:
      - ollama-data:/root/.ollama
    ports:
      - "11434:11434"
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -sf http://localhost:11434/api/version || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  open-webui:
    image: ghcr.io/open-webui/open-webui:latest
    restart: unless-stopped
    depends_on:
      - ollama
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
    ports:
      - "3001:8080"
    volumes:
      - openwebui-data:/app/backend/data
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -sf http://localhost:8080/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  qdrant:
    image: qdrant/qdrant:latest
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-storage:/qdrant/storage

volumes:
  mongo-data:
  redis-data:
  neo4j-data:
  neo4j-logs:
  tigergraph-data:
  ollama-data:
  openwebui-data:
  qdrant-storage:
